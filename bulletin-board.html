<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TODO React App</title>
    <script src="node_modules/react/dist/react.js"></script>
    <script src="node_modules/react-dom/dist/react-dom.js"></script>
    <!-- Add slow but in-browser transpiling. Version 6 and above will not work this way -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.38/browser.js"></script>
    <link rel="stylesheet" type="text/css" href="bulletin-board.css">
</head>
<body>
    <div id="react-container"></div>

    <script type="text/babel">
        var Board = React.createClass({
            propTypes: {
                count: function(props, propName) {
                    if(typeof props[propName] !== 'number') {
                        return new Error('The count must be a number');
                    }

                    if(props[propName] > 100) {
                        return new Error('Creating these many notes is ridiculous');
                    }
                }
            },
            getInitialState() {
                return {
                    notes: []
                }
            },
            nextId() {
                this.uniqueId = this.uniqueId || 0;
                return this.uniqueId++;
            },
            add() {
                var notes = [
                        ...this.state.notes,
                        {
                            id: this.nextId(),
                            text: 'New Note'
                        }
                ];

                this.setState({notes});
            },
            update(newText, id) {
                var notes = this.state.notes.map(
                        note => (note.id !== id) ?
                                note
                                : {
                                    ...note,
                                    text: newText
                                }
                );
                this.setState({notes});
            },
            remove(id) {
                var notes = this.state.notes.filter(note => note.id !== id);
                this.setState({notes});
            },
            eachNote(note) {
                return (
                        <Note key={note.id}
                              id={note.id}
                              onChange={this.update}
                              onRemove={this.remove}>{note.text}
                        </Note>
                )
            },
            render() {
                return (
                        <div className="board">
                            {this.state.notes.map(this.eachNote)}
                            <button onClick={this.add}>+</button>
                        </div>
                );
            }
        });

        var Note = React.createClass({
            getInitialState() {
                return {
                    editing: false,
                    remove: false
                };
            },
            randomBetween(x, y, s) {
                return (x + Math.ceil(Math.random() * (y-x))) + s;
            },
            componentWillMount() {
                this.style = {
                    right: this.randomBetween(0, window.innerWidth - 150, 'px'),
                    top: this.randomBetween(0, window.innerHeight - 150, 'px')
                }
            },
            shouldComponentUpdate(nextProps, nextState) {
                return this.props.children !== nextProps.children || this.state !== nextState;
            },
            componentDidUpdate() {
                if(this.state.editing) {
                    this.refs.newText.focus();
                    this.refs.newText.select();
                }
            },
            edit() {
                this.setState({editing: true});
            },
            save() {
                this.props.onChange(this.refs.newText.value, this.props.id);
                this.setState({
                    editing: false
                });
            },
            remove() {
                this.props.onRemove(this.props.id);
                this.setState({remove: true});
            },
            renderForm() {
                return (
                        <div className="note"
                             style={this.style}>
                            <textarea ref="newText"
                                      defaultValue={this.props.children}></textarea>
                            <button onClick={this.save}>Save</button>
                        </div>
                );
            },
            renderDisplay() {
                return (
                        <div className="note"
                             style={this.style}>
                            <p>{this.props.children}</p>
                            <span>
                                <button onClick={this.edit}>EDIT</button>
                                <button onClick={this.remove}>X</button>
                            </span>
                        </div>
                )
            },
            render() {
                return (this.state.editing) ? this.renderForm() : this.renderDisplay();
            }
        });

//        ReactDOM.render(
//                <Note>Hello World</Note>,
//                document.getElementById('react-container')
//        );

        ReactDOM.render(
                <Board count={10}></Board>,
                document.getElementById('react-container')
        );
    </script>
</body>
</html>